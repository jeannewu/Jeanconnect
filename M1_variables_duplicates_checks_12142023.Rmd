---
title: "Module1_variables_checks_12142023"
author: "JingWU"
date: "2023-12-14"
output:
  pdf_document: default
  html_document: default
---
This program is to check the variables which have the same CIDs in their names but with different length of replicated ending patterns in the module1 and module2 data. Theoretically, these variables are coded as the same responses to a question. Therefore, this code is to check
1. to confirm that responses by these CIDS (by pair) are to the same questions;
2. to check the valid responses by each variables of pairs (replicated patterns) to see whether they are integrated to one;
3. to check how many of these variables (by pattern) are existing in both version 1 and version 2.
4. to double check the existances of these replicate pattern variables in both version 1 and 2 datasets to make sure in order to use the appropriate variable names to integrate these set of pairs of variables.
4. to find a wise way to integrate each common pattern variable into one unique variable for future. 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table) ###to write or read and data management 
library(bigrquery)
library(boxr) ###read or write data from/to box
library(tidyverse) ###for data management https://tidyselect.r-lib.org/reference/faq-external-vector.html
library(dplyr) ###data management some functions are not available in the dplyr masked in the tidyverse
library(reshape)  ###to work on transition from long to wide or wide to long data
library(listr) ###to work on a list of vector, files or..
#library(sqldf) ##sql
#library(lubridate) ###date time it is already masked in 'tidyverse'
library(ggplot2) ###plots
library(ggpubr) ###for the publications of plots
library(RColorBrewer) ###visions color http://www.sthda.com/english/wiki/colors-in-r
library(gridExtra)
#library(stringr) ###to work on patterns, charaters
library(plyr)
library(tidyr)
library(tinytex) #for pdf
library(rmarkdown) ###for the output tables into other files: pdf, rtf, etc.
library(janitor) #to get the summary sum
library(finalfit) #https://cran.r-project.org/web/packages/finalfit/vignettes/export.html t
library(expss) ###to add labels
library(epiDisplay) ##recommended applied here crosstable, tab1
#library(summarytools) ##recommended not applied in this R code
library(gmodels) ##recommended but not applied in this R code
library(magrittr)
library(arsenal)
library(gtsummary)
library(kableExtra)
#library(patchwork)
library(rio)
library(readxl)
library(purrr)
```

## R Markdown

This is an R Markdown document to check the duplicated variables in both versions of Module1 table in prod

```{r, include=FALSE,eval=TRUE,echo=FALSE}
options(knitr.table.format = "latex")
currentDate <- Sys.Date()

#dictionary <- rio::import("https://github.com/episphere/conceptGithubActions/blob/master/aggregate.json",format = "json")
dictionary <- rio::import("https://episphere.github.io/conceptGithubActions/aggregateCopy.json",format = "json")
dd <- dplyr::bind_rows(dictionary,.id="CID")
#dd <- dd[!duplicated(dd),] #remove 140duplicates
#THIS TABLE HAS REPLICATED (CIDS+LABELS) WITH DIFFERENT VARIABLE NAMES,
dd$`Variable Label` <- ifelse(is.na(dd$`Variable Label`), dd$`Variable Name`, dd$`Variable Label`)
#dd <- as.data.frame.matrix(do.call("rbind",dictionary)) #3523, some CID and labels are linked to different variable names 

#dd1 <- dd[!duplicated(dd[,c("CID","Variable Label")]),]
length(unique(dd$CID))
#dd1 <- dd[!duplicated(dd[,c("CID","Variable Label")]),]
length(unique(dd$CID))

#the master dd with more info. on the formats (levels)
urlfile<- "https://raw.githubusercontent.com/episphere/conceptGithubActions/master/csv/masterFile.csv" ###to grab the updated dd from github
y <- read.csv(urlfile)
pii_cid <- y$conceptId.3[which(y$PII == "Yes")]
#dd$labels.combo <- paste(dd$`Variable Label`,dd$`Variable Name`,sep="$")
 bq_auth()
#The bigrquery package is requesting access to your Google account.
#Select a pre-authorised account or enter '0' to obtain a new token.
#Press Esc/Ctrl + C to cancel.

  2 
  
  project <- "nih-nci-dceg-connect-prod-6d04"
  billing <- "nih-nci-dceg-connect-prod-6d04"

schmV1_flatM1 <- bq_project_query(project, query="SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect`.INFORMATION_SCHEMA.COLUMN_FIELD_PATHS WHERE table_name='module1_v1_JP'")
schmV2_flatM1 <- bq_project_query(project, query="SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect`.INFORMATION_SCHEMA.COLUMN_FIELD_PATHS WHERE table_name='module1_v2_JP'")

flatM1schm_V1 <- bigrquery::bq_table_download(schmV1_flatM1,bigint = "character") #1283
flatM1schm_V2 <- bigrquery::bq_table_download(schmV2_flatM1,bigint = "character") #1283

flatM1schm_V2 <- flatM1schm_V2 %>% mutate(long.Ending=ifelse(str_count(sapply(strsplit(column_name,"D_"),tail,1),"_") > 3 , 1,0)) #141 long endings

flatM1schm_V1 <- flatM1schm_V1 %>% mutate(long.Ending=ifelse(str_count(sapply(strsplit(column_name,"D_"),tail,1),"_") > 3 , 1,0)) #174 long endings

##to convert to numeric
  numbers_only <- function(x) !grepl("\\D", x)
#to find the variables with the same pattern only module 1 version 2 has the same CIDs with long and short same pattern endings, not version1

##for the version 1 of module 1
dupM1V1.vars <- NULL 

cnames <- flatM1schm_V1$column_name
for (i in 1:length(flatM1schm_V1$column_name)){
    varname <- cnames[i]
    dup_vars<- flatM1schm_V1$column_name[grepl(varname,flatM1schm_V1$column_name) ]
    
    tmp <- c(varname,dup_vars[!is.na(dup_vars)])
    tmp <- matrix(tmp, nrow=1, ncol=3,byrow=T)
    dupM1V1.vars <- rbind(dupM1V1.vars,tmp)
    dupM1V1.vars <- as.data.frame(dupM1V1.vars)
#dup.vars <- as.data.frame(dup.vars)[complete.cases(dup.vars),]
}

names(dupM1V1.vars) <- c("column_name","matched.varnames1","matched.varnames2") 

dupM1V1.vars <- dupM1V1.vars[which(dupM1V1.vars$matched.varnames1 !=dupM1V1.vars$matched.varnames2), ] %>% 
  mutate(CID.1 = substring(column_name,3,11),
         lastCID = ifelse(nchar(column_name) < 12, sapply(strsplit(matched.varnames2, "D_"),tail,1), substring(sapply(strsplit(column_name, "D_"),tail,1),1,9)))


dupM1V1.var_dd <- merge(dupM1V1.vars, y[,c("conceptId.2","conceptId.3","Current.Source.Question","Current.Format.Value","Variable.Label")],by.x=c("CID.1","lastCID"),by.y=c("conceptId.2","conceptId.3"),all.x=TRUE)

#to check the data on these similar naming variables in module 1 version 1
select <- paste(c(dupM1V1.vars$matched.varnames1,dupM1V1.vars$matched.varnames2),collapse = ",")

#module 1 version 2
dup.vars <- NULL 

cnames <- flatM1schm_V2$column_name
for (i in 1:length(flatM1schm_V2$column_name)){
    varname <- cnames[i]
    dup_vars<- flatM1schm_V2$column_name[grepl(varname,flatM1schm_V2$column_name)]
    
    tmp <- c(varname,dup_vars[!is.na(dup_vars)])
    tmp <- matrix(tmp, nrow=1, ncol=3,byrow=T)
    dup.vars <- rbind(dup.vars,tmp)
    dup.vars <- as.data.frame(dup.vars)
    # 188 pairs in total, including Completed, completed_TS
   
#dup.vars <- as.data.frame(dup.vars)[complete.cases(dup.vars),]
}



names(dup.vars) <- c("column_name","matched.varnames1","matched.varnames2") 

dup.vars <- dup.vars[which(dup.vars$matched.varnames1 !=dup.vars$matched.varnames2), ] #185
max(nchar(dup.vars$column_name))
#[1] 32

con <- dbConnect(
  bigrquery::bigquery(),
  project = project,
  dataset = "FlatConnect",
  billing = billing
)
select <- dup.vars[,c(2:3)]
select1 <- paste(dup.vars$matched.varnames1,collapse=",")
select2 <- paste(dup.vars$matched.varnames2,collapse=",")
#to check whether there is any variable in M1_version 1 in these dup.vars.
length(flatM1schm_V1$column_name[grepl(paste(dup.vars$matched.varnames1,collapse="|"),flatM1schm_V1$column_name)]) #140
length(flatM1schm_V1$column_name[grepl(paste(dup.vars$matched.varnames2,collapse="|"),flatM1schm_V1$column_name)]) #103
query1 <- bq_project_query(project, query=paste("SELECT Connect_ID,", select1,",", select2, "FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module1_v2_JP`",sep=" "))

v2_dup.vars <- bq_table_download(query1, bigint="integer64",n_max = Inf, page_size = 5000)

 v2_dup.vars1 <- v2_dup.vars
 cnames <- names(v2_dup.vars)
 # # # # #  to check variables in recr_noinact_wl1
 for (i in 1: length(cnames)){
    varname <- cnames[i]
    var<-pull(v2_dup.vars1,varname)
    v2_dup.vars1[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
  }

#to check the responses by these variables (by missing counts, values, whether any responses from the same persons)
empty_columns <- colSums(is.na(v2_dup.vars) | v2_dup.vars == "") == nrow(v2_dup.vars)
  #v2_dup.vars<- v2_dup.vars[,!empty_columns]

colnames(v2_dup.vars[,empty_columns])
# [1] "COMPLETED"                                                                    
# [2] "D_384881609_1_1_D_206625031_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1"
#384881609   206625031                                   Sib 1 Anal Cx Age      Age at diagnosis
# [3] "D_483975329_1_1_D_206625031_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1"
#483975329   206625031                                Sib 1 Bladder Cx Age      Age at diagnosis
# [4] "COMPLETED_TS"                                                                 
# [5] "D_317093647_D_206625031" 
#317093647   206625031                               Mom Esophageal Cx Age      Age at diagnosis

length(dup.vars$matched.varnames1[grepl("_1_1_1_|_2_2_2_|_3_3_3_|_4_4_4_|_5_5_5_|_6_6_6_|_7_7_7_|_8_8_8_|_9_9_9_",dup.vars$matched.varnames1)])
#[1] 70
length(dup.vars$matched.varnames2[grepl("_1_1_1_|_2_2_2_|_3_3_3_|_4_4_4_|_5_5_5_|_6_6_6_|_7_7_7_|_8_8_8_|_9_9_9_",dup.vars$matched.varnames2)])
#[1] 62
#these empty columns are the responses to Age on 
compared <- NULL
for (i in 1:length(dup.vars$column_name)){
  vars <- dup.vars$column_name[i] 
    
  var.names <-  colnames(v2_dup.vars)[grepl(vars, colnames(v2_dup.vars))]
  
  tmp <- v2_dup.vars[,c("Connect_ID",var.names)] %>% unite("combind.vars", var.names, na.rm = TRUE, remove = FALSE)
  tmp$compared.var <- vars
  print(c(vars,length(tmp$Connect_ID[complete.cases(tmp)]))) #to check any pairs of responses from #the same Connect_ID #(participants): no 
  # [1] "D_308014437_D_440307926" "60"
  # [1] "D_351657815_D_576646485" "10"                     
  # [1] "D_362270886_D_650100414" "38" 
  # [1] "D_530742915_D_739237614" "1103"   
  # [1] "D_588212264_D_486535201" "191"  
  # [1] "D_797626610_D_774928994" "1085"
  # [1] "D_814510313_D_677702321" "312"                    
  # [1] "D_827393644_D_899840609" "106"
  # [1] "D_976808005_D_852296096" "45"
  #but there is no responses from both short ending and long ending variables 
  var_long <- melt(tmp[which(!is.na(tmp$combind.vars)),],
                   id.vars=c("Connect_ID","compared.var"), 
                   measure.vars=var.names,
                   variable.name="variblenames",
                   value.name="values") %>% filter(.,!is.na(values))
  compared <- rbind(compared,var_long)
}
compared <- compared[!is.na(compared$values),]
compared$endinglength <- ifelse(nchar(compared$variblenames) > nchar(compared$compared.var),"long","short")
compared1 <- compared %>% mutate(values = trimws(values),
                                 endinglength = ifelse(nchar(variblenames) > nchar(compared.var),"long","short")) %>%     filter(is.na(values) | values!="")

summary_m1v2dup <- v2_dup.vars1 %>% select(where(is.numeric)) %>% # select variables to summarise
           map_df(.f = ~ broom::tidy(summary(.x)), .id = "variable")

library(skimr)
summary_m1v2dup <- skim(v2_dup.vars1) %>% as_tibble()
#those responses from the pairs of variables are most are character variables from individual participants, but no any participants had responses from each pair in the same dataset.
length(unique(compared$variblenames[grepl("_1_1_1_|_2_2_2_|_3_3_3_|_4_4_4_|_5_5_5_|_6_6_6_|_7_7_7_|_8_8_8_|_9_9_9_",compared$variblenames)]))
#[1] 130

#to check how many participants are involved with these set of variables and whether the participants had the solid responses from same patterned variables
length(unique(compared$Connect_ID[duplicated(compared$Connect_ID)])) #17278 responses
dim(compared[duplicated(compared[,c("Connect_ID","compared.var")]),])
#[1] 2950    5  2950 participants' responses are related to these pairs of response issues.
dim(compared[which(compared$compared.var=="D_317093647"),])
#[1] 42  4

##to check whether these replicated patterned variables are in the version 1 table:
length(flatM1schm_V1$column_name[grepl(paste(dup.vars$column_name,collapse="|"),flatM1schm_V1$column_name)])
#151

length(flatM1schm_V1$column_name[which(flatM1schm_V1$column_name %in% dup.vars$column_name)]) #49
dup.vars.v1 <-flatM1schm_V1$column_name[which(grepl(paste(dup.vars$column_name,collapse="|"),flatM1schm_V1$column_name))]

flatM1schm_V1<- flatM1schm_V1 %>% 
  mutate(dup.var2.flag = ifelse(grepl(paste(dup.vars$column_name,collapse="|"),column_name), 1, 0), #151: 90 from common.v1v2, 61 only v1
         dup.var2.link = case_when(str_count(column_name,"D_") < 3 & str_count(column_name,"_") < 8 ~ column_name,                                                                  str_count(column_name,"D_") <3 & str_count(column_name,"_") > 7 ~ substring(column_name,1,31),
                                   str_count(column_name,"D_") >2 & str_split_i(column_name,"_D_",1) == paste0("D_",str_split_i(column_name,"_D_",2))  ~ paste0(str_split_i(column_name,"_D_",1),"_D_",str_split_i(column_name,"_D_",3))),
         common.v1v2 = ifelse(column_name %in% flatM1schm_V2$column_name, 1,0),
         conceptId.2 = str_split_i(column_name,"_",2),
         conceptId.3 = substring(str_split_i(column_name,"D_",-1),1,9))
         #Q_CID.1st=unique(y$Current.Source.Question[grepl(str_split_i(column_name,"_",2), y$conceptId.2)]))


table(flatM1schm_V1$long.Ending,flatM1schm_V1$common.v1v2)
  #      0    1
  # 0   79 1238
  # 1   82   92  long.endings 174    
  #          common
unique(str_split_i(flatM1schm_V1$dup.var2.link[which(flatM1schm_V1$long.Ending==1 & flatM1schm_V1$common.v1v2==0)],"_",6))
#[1] "206625031" (XX cancer diagnosis age) "261863326" (XX cancer diagnosis year)
unique(str_split_i(flatM1schm_V1$dup.var2.link[which(flatM1schm_V1$long.Ending==1 & flatM1schm_V1$common.v1v2==0)],"_",2))
#  [1] "142912472" "158354252" "158409298" "195363361" "209771602" "216840563" "247160067" "259089008" "271684775" "278159347"
# [11] "312545873" "315987564" "384881609" "391972881" "483735587" "483975329" "514034680" "519974530" "529744595" "550722030"
# [21] "558929585" "570279754" "654594205" "682651189" "700889863" "750994269" "774774759" "795003496" "845219872" "852278004"
# [31] "860112841" "861788020" "907590067" "907776050" "938150507" "969177591" "990114799"

# to merge with the mater DD by the unique link
flatM1schm_V1_dd1 <- merge(flatM1schm_V1[which(flatM1schm_V1$conceptId.2 !=flatM1schm_V1$conceptId.3),],y[,c("conceptId.2","conceptId.3","Current.Source.Question","Current.Question.Text","Variable.Label")],by=c("conceptId.2","conceptId.3"))

flatM1schm_V1_dd2 <- merge(flatM1schm_V1[which(flatM1schm_V1$conceptId.2 ==flatM1schm_V1$conceptId.3),], y[,c("conceptId.3","Current.Source.Question","Current.Question.Text","Variable.Label")],by="conceptId.3")

flatM1schm_V1_dd0 <- merge(flatM1schm_V1[which(flatM1schm_V1$column_name %nin% c(flatM1schm_V1_dd1$column_name,flatM1schm_V1_dd2$column_name)),],unique(y[!is.na(y$conceptId.2),c("conceptId.2","Current.Source.Question")]), by="conceptId.2")

flatM1schm_V1$column_name[which(flatM1schm_V1$column_name %nin% c(flatM1schm_V1_dd1$column_name,flatM1schm_V1_dd2$column_name,flatM1schm_V1_dd0$column_name))]
#  [1] "COMPLETED"                         "COMPLETED_TS"                      "Connect_ID"                       
#  [4] "D_355472178_BREASTDIS_D_138780721" "D_355472178_BREASTDIS_D_162512268" "D_412624121_D_412624121"          
#  [7] "sha"                               "treeJSON"                          "uid"                              
# [10] "date"  
flatM1schm_V1_dd <- bind_rows(flatM1schm_V1[which(flatM1schm_V1$column_name %nin% c(flatM1schm_V1_dd1$column_name,flatM1schm_V1_dd2$column_name,flatM1schm_V1_dd0$column_name)),], flatM1schm_V1_dd0,flatM1schm_V1_dd1,flatM1schm_V1_dd2)

unique(flatM1schm_V1$conceptId.3[which(flatM1schm_V1$column_name %nin% c(flatM1schm_V1_dd1$column_name,flatM1schm_V1_dd2$column_name))]) #those variables with the CIDs might be deprecated ones, which are not in the current DD: Question: are these variables (86 CIDs) be kept in the BQ2? if so, how to link them to the current CIDs or how to find their corresponding Questions and meaning?
#  [1] "COMPLETED" "TS"        "Connect_I" "206625031" "261863326" "232595513" "614366597" "210004486" "473901019"
# [10] "230633094" "962468280" "479548517" "591959654" "166195719" "861769692" "317093647" "138780721" "162512268"
# [19] "300754548" "714712574" "260972338" "331562964" "388289687" "734800333" "412624121" "497018554" "694594047"
# [28] "204067509" "883468127" "251231642" "727704681" "919193251" "747086784" "195093589" "618107598" "660424548"
# [37] "677702321" "254709325" "543494377" "876238155" "668434958" "716502980" "987134866" "746038746" "745065357"
# [46] "522161060" "957429734" "470282814" "637556277" "351965599" "895115511" "284580415" "870244556" "572909251"
# [55] "367670682" "608469482" "445446905" "599063442" "650332509" "932489634" "574474707" "694973364" "sha"      
# [64] "treeJSON"  "uid"       "date"

unique(dd[grepl(paste(unique(flatM1schm_V1$conceptId.3[which(flatM1schm_V1$column_name %nin% c(flatM1schm_V1_dd1$column_name,flatM1schm_V1_dd2$column_name))]),collapse="|"),dd$CID),c("CID","Variable Label")])
#          CID                                     Variable Label
# 1: 195093589 Another type of cancer: Please describe [text box]
# 2: 206625031                          Skin cancer diagnosis age
# 3: 261863326                         Skin cancer diagnosis year
# 4: 284580415                                     Address line 1
# 5: 317093647                                               <NA>
# 6: 677702321 Another type of cancer: Please describe [text box]
# 7: 746038746                               Prefer not to answer
# 8: 957429734 Another type of cancer: Please describe [text box]
flatM1schm_V1_dd <- flatM1schm_V1_dd %>% 
  mutate(varname_type = case_when(str_count(column_name,"D_|d_") < str_count(column_name,"_") & long.Ending==1 ~ paste(str_count(column_name,"D_|d_"),1,sep="_"),
                                  str_count(column_name,"D_|d_") < str_count(column_name,"_") & long.Ending==0 ~ paste(str_count(column_name,"D_|d_"),2,sep="_"),
                                  str_count(column_name,"D_|d_") == str_count(column_name,"_") & long.Ending==0 ~ paste(str_count(column_name,"D_|d_"),0,sep="_"))) 




flatM1schm_V2<- flatM1schm_V2 %>% 
  mutate(dup.var2.flag = ifelse(grepl(paste(dup.vars$column_name,collapse="|"),column_name), 1, 0),
         dup.var2.link = case_when(str_count(column_name,"D_") < 3 & str_count(column_name,"_") < 8 ~ column_name,                                                                  str_count(column_name,"D_") <3 & str_count(column_name,"_") > 7 ~ substring(column_name,1,31),
                                   str_count(column_name,"D_") >2 & str_split_i(column_name,"_D_",1) == paste0("D_",str_split_i(column_name,"_D_",2))  ~ paste0(str_split_i(column_name,"_D_",1),"_D_",str_split_i(column_name,"_D_",3))),
         common.v1v2 = ifelse(column_name %in% flatM1schm_V1$column_name, 1,0),
         conceptId.2 = str_split_i(column_name,"_",2),
         conceptId.3 = substring(str_split_i(column_name,"D_|d_",-1),1,9))
table(flatM1schm_V2$dup.var2.flag,flatM1schm_V2$long.Ending)
  #  
  #      0    1
  # 0 1712    9
  # 1  239  132
   

unique(str_split_i(flatM1schm_V2$dup.var2.link[which(flatM1schm_V2$long.Ending==1 & flatM1schm_V2$common.v1v2==0)],"_",6))  #[1] "206625031" "261863326"
unique(str_split_i(flatM1schm_V2$dup.var2.link[which(flatM1schm_V2$long.Ending==1 & flatM1schm_V2$common.v1v2==0)],"_",2))
#  [1] "116065851" "142912472" "158409298" "204425387" "209771602" "216840563" "247160067" "259089008" "278159347" "312545873"
# [11] "315987564" "384881609" "483735587" "513077276" "514034680" "529744595" "570279754" "601211723" "654594205" "700889863"
# [21] "750994269" "774774759" "852278004" "860112841" "861788020" "905145893" "907590067" "969177591" "990114799"                                                                                                                           
flatM1schm_V2_dd1 <- merge(flatM1schm_V2[which(flatM1schm_V2$conceptId.2 !=flatM1schm_V2$conceptId.3),],y[,c("conceptId.2","conceptId.3","Current.Source.Question","Current.Question.Text","Variable.Label")],by=c("conceptId.2","conceptId.3"))

flatM1schm_V2_dd2 <- merge(flatM1schm_V2[which(flatM1schm_V2$conceptId.2 ==flatM1schm_V2$conceptId.3),], y[,c("conceptId.3","Current.Source.Question","Current.Question.Text","Variable.Label")],by="conceptId.3")


flatM1schm_V2_dd0 <- merge(flatM1schm_V2[which(flatM1schm_V2$column_name %nin% c(flatM1schm_V2_dd1$column_name,flatM1schm_V2_dd2$column_name)),],unique(y[,c("conceptId.2","Current.Source.Question")]), by="conceptId.2")

dim(flatM1schm_V2[which(flatM1schm_V2$column_name %nin% c(flatM1schm_V2_dd1$column_name,flatM1schm_V2_dd2$column_name)),])
#[1] 54 13 01/08/2024
#[1] 49 15 01/09/2024
flatM1schm_V2$column_name[which(flatM1schm_V2$column_name %nin% c(flatM1schm_V2_dd1$column_name,flatM1schm_V2_dd2$column_name,flatM1schm_V2_dd0$column_name))]
#[1] "COMPLETED_TS" "Connect_ID" 0/1/8/2024
# [1] "Connect_ID" 01/09/2024
flatM1schm_V2_dd <- bind_rows(flatM1schm_V2[which(flatM1schm_V2$column_name %nin% c(flatM1schm_V2_dd1$column_name,flatM1schm_V2_dd2$column_name,flatM1schm_V2_dd0$column_name)),],flatM1schm_V2_dd0,flatM1schm_V2_dd1,flatM1schm_V2_dd2)  

unique(flatM1schm_V2$conceptId.3[which(flatM1schm_V2$column_name %nin% c(flatM1schm_V2_dd1$column_name,flatM1schm_V2_dd2$column_name))])
#  [1] "COMPLETED" "TS"        "Connect_I" "206625031" "261863326" "317093647" "426285737" "578895128" "195093589"
# [10] "618107598" "660424548" "677702321" "254709325" "746038746" "957429734" "812370563" "284580415" "sha"       
# [19] "treeJSON"  "uid"       "date"   01/06/2024
# [1] "Connect_I" "206625031" "261863326" "317093647" "426285737" "578895128" "195093589" "618107598" "660424548"
# [10] "254709325" "746038746" "957429734" "812370563" "284580415" "uid"       "date" 01/09/2024
y[grepl("677702321",y$conceptId.3),c("conceptId.3","Current.Question.Text")]
#      conceptId.3                                       Current.Question.Text
# 2748   677702321 Mother - another type of cancer: Please describe [text box]
unique(dd[grepl(paste(unique(flatM1schm_V2$conceptId.3[which(flatM1schm_V2$column_name %nin% c(flatM1schm_V2_dd1$column_name,flatM1schm_V2_dd2$column_name))]),collapse="|"),dd$CID),c("CID","Variable Label")])
#           CID                                     Variable Label
#  1: 195093589 Another type of cancer: Please describe [text box]
#  2: 206625031                          Skin cancer diagnosis age
#  3: 261863326                         Skin cancer diagnosis year
#  4: 284580415                                     Address line 1
#  5: 317093647                                               <NA>
#  6: 578895128                                               <NA>
#  7: 677702321 Another type of cancer: Please describe [text box]
#  8: 746038746                               Prefer not to answer
#  9: 812370563                                               <NA>
# 10: 957429734 Another type of cancer: Please describe [text box]
 
flatM1schm_V2_dd <- flatM1schm_V2_dd %>% 
  mutate(varname_type = case_when(str_count(column_name,"D_|d_") < str_count(column_name,"_") & long.Ending==1 ~ paste(str_count(column_name,"D_|d_"),1,sep="_"),
                                  str_count(column_name,"D_|d_") < str_count(column_name,"_") & long.Ending==0 ~ paste(str_count(column_name,"D_|d_"),2,sep="_"),
                                  str_count(column_name,"D_|d_") == str_count(column_name,"_") & long.Ending==0 ~ paste(str_count(column_name,"D_|d_"),0,sep="_"))) 
         
length(flatM1schm_V1$dup.var2.link[which(dup.vars$column_name %in% flatM1schm_V1$dup.var2.link)])
#[1] 146 01/08/2024
# [1] 136
select3 <- paste(flatM1schm_V1$column_name[which(grepl(paste(unique(c(dup.vars$column_name,dupM1V1.vars$matched.varnames1,dupM1V1.vars$matched.varnames2)),collapse="|"),flatM1schm_V1$column_name))],collapse=",") #153

query11 <- bq_project_query(project, query=paste("SELECT Connect_ID,", select3, ", FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module1_v1_JP`",sep=" "))

v1_dup.vars1 <- bq_table_download(query11, bigint="integer64",n_max = Inf, page_size = 5000)

 ###convert the numeric
 v1_dup.vars1 <- v1_dup.vars1
 cnames <- names(v1_dup.vars1)
 # # # # #  to check variables in recr_noinact_wl1
 for (i in 1: length(cnames)){
    varname <- cnames[i]
    var<-pull(v1_dup.vars1,varname)
    v1_dup.vars1[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
  }
 

summary_m1v1dup <- v1_dup.vars1 %>% select(where(is.numeric)) %>% # select variables to summarise
           map_df(.f = ~ broom::tidy(summary(.x)), .id = "variable")

# the question on the variable d_317093647
y[grepl("317093647",y$conceptId.2),c("conceptId.2","Current.Source.Question")]
#      conceptId.2
# 2763   317093647
# 2764   317093647
#                                                                                                                           Current.Source.Question
# 2763 Mother - How old was your mother when they were first told by a doctor or other health professional that they have or had esophageal cancer?
# 2764 Mother - How old was your mother when they were first told by a doctor or other health professional that they have or had esophageal cancer?
View(y)

#to check the non missing input of each question

v1_dup.vars1$missing.counts <- rowSums(is.na(v1_dup.vars1))
summary(v1_dup.vars1$missing.counts)
v1_dup.vars1$version <- 1


#to check how many dup patterned variables in version 1 are overlapping with the ones in the version 2



##summary dup.vars from both versions in Module 1
dup.vars_dd <- dup.vars %>% mutate(CID.1 = substring(column_name,3,11),
                                   lastCID = ifelse(nchar(column_name) < 12, sapply(strsplit(matched.varnames2, "D_"),tail,1), substring(sapply(strsplit(column_name, "D_"),tail,1),1,9)))


dup.var_dd1 <- merge(dup.vars_dd, flatM1schm_V1[which(flatM1schm_V1$dup.var2.flag==1),c("column_name","dup.var2.link")], by.x="column_name", by.y="dup.var2.link",all.x=TRUE) #to check the overall lapping variables between version1 and version2 on these same patterned variables

names(dup.var_dd1)[6] <- "dupV1.varnames"

dup.var_dd1 <- dup.var_dd1 %>% 
  mutate(dupvars_bothV1V2 = ifelse(is.na(dupV1.varnames),NA, 
                                   ifelse(dupV1.varnames == matched.varnames1 | dupV1.varnames == matched.varnames2, 1, 0)),
         long.Ending=ifelse(str_count(sapply(strsplit(matched.varnames1,"D_"),tail,1),"_") > 3 | str_count(sapply(strsplit(matched.varnames2,"D_"),tail,1),"_") > 3 , 1,0),#134
         digits.Ends=ifelse(str_count(sapply(strsplit(matched.varnames1,"D_"),tail,1),"_") > 0 | str_count(sapply(strsplit(matched.varnames2,"D_"),tail,1),"_") > 0 , 1,0)) 


dup.vars_dd1 <- merge(dup.var_dd1,y[,c("conceptId.2","conceptId.3","Current.Source.Question","Current.Format.Value","Variable.Label")],by.x=c("CID.1","lastCID"),by.y=c("conceptId.2","conceptId.3"))

table(dup.var_dd1$long.Ending) #132 long.Endings
flatM1schm_V2$column_name[which(flatM1schm_V2$long.Ending==1 & flatM1schm_V2$column_name %nin% c(dup.var_dd1$matched.varnames1,dup.var_dd1$matched.varnames2))]
# [1] "D_116065851_3_3_D_206625031_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3"                           
# [2] "D_142912472_9_9_D_206625031_9_9_9_9_9_9_9_9_9_9_9_9_9_9_9_9_9_9_9_9_9_9_9_9_9"                           
# [3] "D_158409298_7_7_D_206625031_7_7_7_7_7_7_7_7_7_7_7_7_7_7_7_7_7_7_7_7_7_7_7_7_7"                           
# [4] "D_216840563_5_5_D_261863326_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5"                           
# [5] "D_247160067_5_5_D_206625031_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5"                           
# [6] "D_483735587_5_5_D_261863326_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5_5"                           
# [7] "D_513077276_3_3_D_206625031_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3"                           
# [8] "D_513077276_3_3_D_261863326_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3"                           
# [9] "D_570279754_11_11_D_206625031_11_11_11_11_11_11_11_11_11_11_11_11_11_11_11_11_11_11_11_11_11_11_11_11_11"
table(dup.var_dd1$digits.Ends) #177

#to compare the responses of these 151 variables between version 1 and version 2
v2_dup.vars$version <- 2
dup.vars_v12 <- bind_rows(v1_dup.vars,v2_dup.vars[,c("Connect_ID","version",dup.vars.v1)])

  numbers_only <- function(x) !grepl("\\D", x)

 ###convert the numeric
dup.dt12 <- dup.vars_v12
cnames <- names(dup.vars_v12)
#  to check variables in dup.vars_v12
for (i in 1: length(cnames)){
   varname <- cnames[i]
   var<-pull(dup.dt12,varname)
   dup.dt12[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
}


dup.dt12.compare <- dup.dt12 %>% group_by(version) %>% split(.$version) %>% map(summary) %>% as_tibble()
#D_308014437_D_440307926 
D_308014437_D_308014437_D_440307926 

# D_317093647_D_206625031 D_317093647
# D_351657815_D_351657815_D_576646485 (num)  D_351657815_D_576646485 (chr)
# D_362270886_D_362270886_D_650100414 (num)  D_362270886_D_650100414 
# D_530742915_D_530742915_D_739237614 (num)  D_530742915_D_739237614
# D_588212264_D_588212264_D_486535201.(num)  D_588212264_D_486535201
# D_797626610_D_797626610_D_774928994.       D_797626610_D_774928994
# D_814510313_D_814510313_D_677702321
# D_827393644_D_899840609
# D_976808005_D_852296096
  # [1] "D_308014437_D_440307926" "60"
  # [1] "D_351657815_D_576646485" "10"                     
  # [1] "D_362270886_D_650100414" "38" 
  # [1] "D_530742915_D_739237614" "1103"   
  # [1] "D_588212264_D_486535201" "191"  
  # [1] "D_797626610_D_774928994" "1085"
  # [1] "D_814510313_D_677702321" "312"                    
  # [1] "D_827393644_D_899840609" "106"
  # [1] "D_976808005_D_852296096" "45"

colnames(dup.dt12[ grepl("\\D",dup.dt12),])
char.var <- list()
for (i in 1: length(cnames)){
   varname <- cnames[i]
   var<-pull(dup.dt12,varname)
   #ifelse(!numbers_only(var), print(varname), print("numeric"))
   char.var[[i]] <-ifelse(!numbers_only(var), varname, NA)
}

ls <- unique(unlist(char.var)[which(unlist(char.var)!="NA")])
#[1] "D_308014437_D_440307926"       "D_351657815_D_576646485"       "D_362270886_D_650100414"      
# [4] "D_530742915_D_739237614"       "D_537137982_2_2_D_338020179_2" "D_537137982_3_3_D_338020179_3"
# [7] "D_578895128_1_1_D_957429734_1" "D_578895128_2_2_D_957429734_2" "D_578895128_3_3_D_957429734_3"
#[10] "D_578895128_4_4_D_957429734_4" "D_588212264_D_486535201"       "D_797626610_D_774928994"      
#[13] "D_812370563_1_1_D_933110091_1" "D_814510313_D_677702321"       "D_827393644_D_899840609"      
#[16] "D_976808005_D_852296096"  

dup_v1.vars <-unique(compared[which(colnames(dup.dt12) %in% compared$variblenames), c("compared.var","variblenames")])
 dup_v1.vars
 #                      compared.var                                                                  variblenames
 # 1: D_116065851_1_1_D_206625031_1_1                                               D_116065851_1_1_D_206625031_1_1
#  2: D_142912472_1_1_D_206625031_1_1                                               D_142912472_1_1_D_206625031_1_1
#  3: D_142912472_1_1_D_206625031_1_1 D_142912472_1_1_D_206625031_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1
#  4: D_142912472_1_1_D_261863326_1_1                                               D_142912472_1_1_D_261863326_1_1
#  5: D_142912472_1_1_D_261863326_1_1 D_142912472_1_1_D_261863326_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1_1
#  6: D_142912472_2_2_D_261863326_2_2 D_142912472_2_2_D_261863326_2_2_2_2_2_2_2_2_2_2_2_2_2_2_2_2_2_2_2_2_2_2_2_2_2
#  7: D_142912472_2_2_D_261863326_2_2                                               D_142912472_2_2_D_261863326_2_2
#  8: D_142912472_3_3_D_206625031_3_3 D_142912472_3_3_D_206625031_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3
#  9: D_142912472_3_3_D_206625031_3_3                                               D_142912472_3_3_D_206625031_3_3
# 10: D_142912472_3_3_D_261863326_3_3 D_142912472_3_3_D_261863326_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3_3
# 11: D_142912472_3_3_D_261863326_3_3                                               D_142912472_3_3_D_261863326_3_3
#12: D_142912472_6_6_D_261863326_6_6 D_142912472_6_6_D_261863326_6_6_6_6_6_6_6_6_6_6_6_6_6_6_6_6_6_6_6_6_6_6_6_6_6
#13: D_158354252_1_1_D_206625031_1_1                                               D_158354252_1_1_D_206625031_1_1
 
#to go through the whole set of schemas of each version of M1 on the variable names:


```

Here below are the code to check the module 2 on the similar variabless with the same name patterns

```{r}
schmV1_flatM2 <- bq_project_query(project, query="SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect`.INFORMATION_SCHEMA.COLUMN_FIELD_PATHS WHERE table_name='module2_v1_JP'")
schmV2_flatM2 <- bq_project_query(project, query="SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect`.INFORMATION_SCHEMA.COLUMN_FIELD_PATHS WHERE table_name='module2_v2_JP'")

flatM2schm_V1 <- bigrquery::bq_table_download(schmV1_flatM2,bigint = "character") 
flatM2schm_V2 <- bigrquery::bq_table_download(schmV2_flatM2,bigint = "character") 

dupM2.vars <- NULL 

cnames <- flatM2schm_V2$column_name
for (i in 1:length(flatM2schm_V2$column_name)){
    varname <- cnames[i]
    dupM2_vars<- ifelse(grepl(varname,flatM2schm_V2$column_name),flatM2schm_V2$column_name[grepl(varname,flatM2schm_V2$column_name) ],NA)
    
    tmp <- c(varname,dupM2_vars[!is.na(dupM2_vars)])
    tmp <- matrix(tmp, nrow=1, ncol=3)
    dupM2.vars <- rbind(dupM2.vars,tmp)
    dupM2.vars <- as.data.frame(dupM2.vars)
   
}

names(dupM2.vars) <- c("column_name","matched.varnames1","matched.varnames2") 

dupM2.vars1 <- dupM2.vars[which(dupM2.vars$matched.varnames1 != dupM2.vars$matched.varnames2), ]
select1 <- paste(dupM2.vars$matched.varnames1,collapse=",")
select2 <- paste(dupM2.vars$matched.varnames2,collapse=",")

query2 <- bq_project_query(project, query=paste("SELECT Connect_ID,", select1,",", select2, "FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module2_v2_JP`",sep=" "))

m2v2_dup.vars <- bq_table_download(query2, bigint="integer64",n_max = Inf, page_size = 5000)
empty_columns <- colSums(is.na(m2v2_dup.vars) | m2v2_dup.vars == "") == nrow(m2v2_dup.vars)
  #m2v2_dup.vars<- v2_dup.vars[,!empty_columns]

##Module 2 version 1 data
dupM2v1.vars <- NULL 

cnames <- flatM2schm_V1$column_name
for (i in 1:length(flatM2schm_V1$column_name)){
    varname <- cnames[i]
    dupM2v1_vars<- ifelse(grepl(varname,flatM2schm_V1$column_name),flatM2schm_V1$column_name[grepl(varname,flatM2schm_V1$column_name) ],NA)
    
    tmp <- c(varname,dupM2v1_vars[!is.na(dupM2v1_vars)])
    tmp <- matrix(tmp, nrow=1, ncol=3)
    dupM2v1.vars <- rbind(dupM2v1.vars,tmp)
    dupM2v1.vars <- as.data.frame(dupM2v1.vars)

}

names(dupM2v1.vars) <- c("column_name","matched.varnames1","matched.varnames2") 

dupM2v1.vars <- dupM2v1.vars[which(dupM2v1.vars$matched.varnames1 !=dupM2v1.vars$matched.varnames2), ]
dupM2v1.vars$version <-1
dupM2.vars$version <-2

dupM2both.vars <- bind_rows(dupM2v1.vars,dupM2.vars) %>% 
  mutate(CID.1 = substring(column_name,3,11),
         lastCID = ifelse(nchar(column_name) < 12, sapply(strsplit(matched.varnames2, "D_"),tail,1), substring(sapply(strsplit(column_name, "D_"),tail,1),1,9)))

dupM2.vars_dd <- merge(dupM2both.vars,y[,c("conceptId.2","conceptId.3","Current.Source.Question","Current.Format.Value","Variable.Label")],by.x=c("CID.1","lastCID"),by.y=c("conceptId.2","conceptId.3"))

dd[grepl("648960871",dd$CID),]
# A tibble: 1 × 3
#   CID       `Variable Label` `Variable Name`
#   <chr>     <chr>            <chr>          
# 1 648960871 Never            Never          
dd[grepl("496539718",dd$CID),]
# A tibble: 1 × 3
#   CID       `Variable Label`        `Variable Name`           
#   <chr>     <chr>                   <chr>                     
# 1 496539718 Age First Period, Never SrvMRE_FirstPeriAgeNH_v1r0

select <- paste(c(dupM2v1.vars$matched.varnames1,dupM2v1.vars$matched.varnames2),collapse = ",")

query3 <- bq_project_query(project, query=paste("SELECT Connect_ID,",select, "FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module2_v1_JP`",sep=" "))

m2v1_dup.vars <- bq_table_download(query3, bigint="integer64",n_max = Inf, page_size = 5000)
empty_columns <- colSums(is.na(m2v1_dup.vars) | m2v1_dup.vars == "") == nrow(m2v2_dup.vars)


```


## Output datasets



```{r, include=FALSE,eval=TRUE,echo=FALSE}}
outputpath <- "~/Documents/Connect_projects/Biospecimen_Feb2022/Jing_projects/biospecQC_03082022/data/"
write.csv(dup.vars_dd1,paste(outputpath, "Module1_variables_sameCIDs_V1V2_check_",Sys.Date(),".csv",sep=""))
write.csv(summary_m1v1dup,paste(outputpath, "Module1_version1_similiar_variable_check_summary_numeric_", Sys.Date(),".csv",sep=""))
write.csv(summary_m1v2dup,paste(outputpath, "Module1_version2_similiar_variable_check_summary_numeric_", Sys.Date(),".csv",sep=""))
write.csv(compared1,paste(outputpath, "Module1_version2_similiar_variable_data_", Sys.Date(),".csv",sep=""))
write.csv(dupM2.vars_dd,paste(outputpath, "Module2_variables_sameCIDs_V1V2_check_",Sys.Date(),".csv",sep=""))

#the schema with the masterDD explanations

write.csv(flatM1schm_V1_dd, paste(outputpath, "Module1_V1_schema_variables_masterDD_check_",Sys.Date(),".csv",sep=""),row.names = F,quote = F,na=" ")
write.table(flatM1schm_V1_dd, paste(outputpath, "Module1_V1_schema_variables_masterDD_check_",Sys.Date(),".txt",sep=""),sep="\t",row.names = F,quote = F,na=" ")

write.csv(flatM1schm_V2_dd, paste(outputpath, "Module1_V2_schema_variables_masterDD_check_",Sys.Date(),".csv",sep=""),row.names = F,quote = F,na="")
write.table(flatM1schm_V2_dd, paste(outputpath, "Module1_V2_schema_variables_masterDD_check_",Sys.Date(),".txt",sep=""),sep="\t",row.names = F,quote = F,na=" ")
```


```{r}

age_year <- flatM1schm_V2[grepl("150352141|122887481|534007917|752636038|518750011|275770221|527057404", flatM1schm_V2$column_name),]
age_year_v1 <- flatM1schm_V1[grepl("150352141|122887481|534007917|752636038|518750011|275770221|527057404", flatM1schm_V1$column_name),]

dt_bq <- function(q,data){
    select <- paste(q,collapse = ",")
    query <-  eval(parse(text=paste("bq_project_query(project, query=\"SELECT Connect_ID,",select," FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.",data,"`\")",sep="")))
   
   dt<- bq_table_download(query,bigint="integer64",n_max = Inf, page_size = 500) 

   
}
query2 <- paste(age_year$column_name,collapse=",")
m1v2_age_year <- dt_bq(age_year$column_name,"module1_v2_JP")
   dt1 <- m1v2_age_year
   cnames <- names(dt1)
#  to check variables in dt
for (i in 1: length(cnames)){
    varname <- cnames[i]
    var<-pull(dt1,varname)
    dt1[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
}
sum_ageyear2 <- skim(dt1) %>% as_tibble()
write.csv(sum_ageyear2,paste(outputpath, "Module1_versio2_Age_year_surgery_variables_check_summary_numeric_", Sys.Date(),".csv",sep=""))

```
##to combine the not null values of those variables with similar name patterns in the module1 version 2
I have developed another sql for combining the values of these variables with type 3 pattern
DECLARE columns STRING;
SET columns = (
WITH selected_columns as (
SELECT column_name 
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect`.INFORMATION_SCHEMA.COLUMNS
WHERE 
table_name = 'module1_v2_JP' AND REGEXP_CONTAINS(column_name, "D_116065851_1_1_D_206625031_1_1")
)
SELECT STRING_AGG(column_name) AS columns 
  FROM selected_columns
);

EXECUTE IMMEDIATE format("SELECT Connect_ID, %s, coalesce(%s) as combo  FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module1_v2_JP`", columns, columns);


```{r}
#x is a pattern
combine_renames.txt<- function(x,schema) {
  pairs <- schema$column_name[grep(x,schema$column_name)]
  pairs.txt <- paste("combine_and_rename([",x1, x2,"])  AS",x_combo, sep=" ")
}

sql.pair.var <- paste(dup.var_dd1[which(dup.var_dd1$long.Ending==1),c("matched.varnames1","matched.varnames2")],collapse=",")

dup.var_dd1$pairs <- ifelse(dup.var_dd1$long.Ending==1, paste(dup.var_dd1$matched.varnames1,dup.var_dd1$matched.varnames2,sep=","), NA)

dup.var_dd1$sql.newnames <- ifelse(dup.var_dd1$digits.Ends==1, paste0("D_",dup.var_dd1$CID.1,"_D_",dup.var_dd1$lastCID,"_", str_split_i(dup.var_dd1$column_name,"_",-1)),  NA)

dup.var_dd1$sql.pairs <- ifelse(dup.var_dd1$digits.Ends==1, paste0("COALESCE(",dup.var_dd1$matched.varnames1,",",dup.var_dd1$matched.varnames2,") AS ", dup.var_dd1$sql.newnames), NA)

dup.var_dd1$sql.pairs_JP <- ifelse(dup.var_dd1$digits.Ends==1, paste0("combine_and_rename([",dup.var_dd1$matched.varnames1,",",dup.var_dd1$matched.varnames2,"]) AS ", dup.var_dd1$sql.newnames), NA)


write.table(paste("SELECT Connect_ID,\n",paste(dup.var_dd1[which(dup.var_dd1$long.Ending==1)]$sql.pairs_JP,collapse=", \n")," \nFROM  `nih-nci-dceg-connect-prod-6d04.FlatConnect.module1_v2_JP`",sep=""),"~/Documents/Connect_projects/Biospecimen_Feb2022/Jing_projects/biospecQC_03082022/data/M1V2_Variable_similar_query_rename_combine_JP_01022024.txt", sep="\t",row.names = F,quote = F,col.names = F)

write.table(paste("SELECT Connect_ID,\n",paste(dup.var_dd1[which(dup.var_dd1$long.Ending==1)]$sql.pairs,collapse=", \n")," \nFROM  `nih-nci-dceg-connect-prod-6d04.FlatConnect.module1_v2_JP`",sep=""),"~/Documents/Connect_projects/Biospecimen_Feb2022/Jing_projects/biospecQC_03082022/data/M1V2_Variable_similar_query_coalesce_01022024.txt", sep="\t",row.names = F,quote = F,col.names = F)

#simple chcek with a pair 
#e.g. nchar("D_116065851_1_1_D_206625031_1_1")
#[1] 31
coalesce_rename <- function(x,data){
  
  pattern <- substring(as.string(x),1,31)
  query <-  eval(parse(text=paste("bq_project_query(project, query=\"SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect`.
                                 INFORMATION_SCHEMA.COLUMN_FIELD_PATHS WHERE table_name='",data,
                                   "'\")",sep="")))
   
   schema <- bq_table_download(query,bigint="integer64",n_max = Inf, page_size = 500) 
  
  if(length(schema$column_name[grepl(pattern, schema$column_name)])==2){
  
  sql.txt <- paste0("DECLARE columns STRING;
SET columns = (
WITH selected_columns as (
SELECT column_name 
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect`.INFORMATION_SCHEMA.COLUMNS
WHERE 
table_name = '",data,"' AND REGEXP_CONTAINS(column_name, \"", x,"\")
)
SELECT STRING_AGG(column_name) AS columns 
  FROM selected_columns
);\n

EXECUTE IMMEDIATE format(\"SELECT Connect_ID, %s, coalesce(%s) as combo  FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.",data,"`\", columns, columns);",sep="")
  }
  else {sql.txt <- c(x, NA)}
return(c(x,sql.txt))
}

###to update the sql text as we discussed variables ( Scenirio 2 and 3 ) can be combined and renamed on Jan. 3, 2023 with the agreements of Jake, and Nicole. And we will use the function "coalesce" to combine each pair of variables in the BQ2 data
write.table(paste("SELECT Connect_ID,\n",paste(dup.var_dd1$sql.pairs[which(dup.var_dd1$digits.Ends==1)],collapse=", \n")," \nFROM  `nih-nci-dceg-connect-prod-6d04.FlatConnect.module1_v2_JP`",sep=""),"~/Documents/Connect_projects/Biospecimen_Feb2022/Jing_projects/biospecQC_03082022/data/M1V2_Variable_similar_query_coalesce_01042024.txt", sep="\t",row.names = F,quote = F,col.names = F)


```

#to create the general functions to pull all the pairs of variables to the same response in the module data by their similar name patterns as Jake requested on Jan. 12, 2024:
 the work flow is to
 a. check the schema to group the variable names in general:
    1. "long.endings": with long endings (yes/no);
    2. "varname_type": with numbers of CIDs (0~3) and with long tails (> 3 or not= Long,Short, Notails): Long_#CIDs, Short_#CIDs, Notails_#CIDs find the duplicated patterns of the variable names, 
 b. group the variable names with the duplicated patterns as pairs with the long tails, short tails, and notails but some issues (CID2_CID3 (txt responses), CID2_CID2_CID3(as 0)), 
 c. develop the sql queries in text of each patterns to coalesce in the process the data( duplicated ones:Long tail, and Short tails);
 d. develop the sql query for renaming the variables only with long tails;
 
```{r}
dup.long <- function(tb){
  schm_query <- eval(parse(text=paste("bq_project_query(project, query=\"SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect`.
                                 INFORMATION_SCHEMA.COLUMN_FIELD_PATHS WHERE table_name='",tb,
                                   "'\")",sep="")))

schema <- bigrquery::bq_table_download(schm_query,bigint = "character")
  schema <- schema %>% 
    mutate(long.Ending=ifelse(str_count(sapply(strsplit(column_name,"D_"),tail,1),"_") > 3 , 1,0),
           newname.long = ifelse(str_count(column_name,"D_") >1 & str_count(sapply(strsplit(column_name,"D_"),tail,1),"_") > 0, paste0(substring(column_name,1,11),"_D_",substring(str_split_i(column_name,"D_",-1),1,11)), column_name),
           var.pattern = case_when(str_count(column_name,"D_|d_") < 3 & str_count(column_name,"_") < 7 ~ column_name,                                                str_count(column_name,"D_|d_") <3 & str_count(column_name,"_") > 6 ~ substring(column_name,1,29),
                                   str_count(column_name,"D_|d_") >2 & str_split_i(column_name,"D_",2) == str_split_i(column_name,"D_",3) ~ paste0(str_split_i(column_name,"_D_",1),"_D_",str_split_i(column_name,"_D_",3)),
                                   str_count(column_name,"D_|d_") >2 & 2*str_count(column_name,"D_|d_")  > str_count(column_name,"_") & str_split_i(column_name,"_D_",1) != str_split_i(column_name,"_D_",2)  ~ column_name,
                                   str_count(column_name,"D_|d_") >2 & 2*str_count(column_name,"D_|d_")  < str_count(column_name,"_") & str_split_i(column_name,"_D_",1) != str_split_i(column_name,"_D_",2)  ~ column_name),
           varname_type = case_when(str_count(column_name,"D_|d_") < str_count(column_name,"_") & long.Ending==1 ~ paste("Long",str_count(column_name,"D_|d_"),sep="_"),
                                  str_count(column_name,"D_|d_") < str_count(column_name,"_") & long.Ending==0 ~ paste("Short",str_count(column_name,"D_|d_"),str_count(sapply(strsplit(column_name,"D_"),tail,1),"_"),sep="_"),
                                  str_count(column_name,"D_|d_") == str_count(column_name,"_") & long.Ending==0 ~ paste("Notails",str_count(column_name,"D_|d_"),sep="_")),
          conceptId.2 = str_split_i(column_name,"_",2),
          conceptId.3 = ifelse(str_count(column_name,"_D_") >0, substring(str_split_i(column_name,"_D_",-1),1,9),NA),
          pii_cid3 = ifelse(substring(str_split_i(column_name,"_D_",-1),1,9) %in% pii_cid, 1,0)) 
  #%>% filter(.,duplicated(schema$var.pattern)) %>% select(table_name, column_name,var.pattern,newname.long,varname_type)
 
   dups <- schema$var.pattern[duplicated(schema$var.pattern)]
   dups.long <- schema$var.pattern[duplicated(schema$var.pattern) & grepl("Long",schema$varname_type) & schema$pii_cid3 !=1]
   
   #dup.vars.long <- schema %>% filter(.,var.pattern %in% dups) %>% select(column_name, varname_type, var.pattern) %>% pivot_wider(names_from = varname_type, values_from = column_name, values_fill = 0)       
   #dup_long <- dup.var.long[!is.na(long_2),]   
 if(length(dups.long)>0){
 sql.long <- NULL    
    for (i in 1:length(dups.long)){
     sql.newnames <- paste0(substring(dups.long[i],1,11),"_D_",str_split_i(dups.long[i],"D_",-1)) 
     sql <- glue("COALESCE(",paste(schema$column_name[grepl(dups.long[i],schema$column_name)],collapse=","),") AS ", sql.newnames)
     sql.long <- c(sql.long,sql)
    }
   
 write.table(paste0("SELECT Connect_ID,\n ",paste(sql.txt,collapse=",\n"), " \nFROM  `nih-nci-dceg-connect-prod-6d04.FlatConnect.",tb,"`"),paste0("~/Documents/Connect_projects/Biospecimen_Feb2022/Jing_projects/biospecQC_03082022/data/",tb,"_no_pii_Long_similar_query_coalesce_",Sys.Date(),".txt",sep=""), sep="\t",row.names = F,quote = F,col.names = F) #M1V2_Variable
 }
   
 ##to write the sql for "coalesce" the duplicate variables with short tails
 dups.short <- schema$var.pattern[duplicated(schema$var.pattern) & !grepl("Long|_0",schema$varname_type) & schema$pii_cid3!=1]
 if(length(dups.short >0)){
 sql.short <- NULL
     for (i in 1:length(dups.short)){
     sql.newnames <- paste0(substring(dups.short[i],1,11),"_D_",str_split_i(dups.short[i],"D_",-1)) 
     sql <- glue("COALESCE(",paste(schema$column_name[grepl(dups.short[i],schema$column_name)],collapse=","),") AS ", sql.newnames)
     sql.short <- c(sql.short,sql)
    }
   
 write.table(paste0("SELECT Connect_ID,\n ",paste(sql.short,collapse=",\n"), " \nFROM  `nih-nci-dceg-connect-prod-6d04.FlatConnect.",tb,"`"),paste0("~/Documents/Connect_projects/Biospecimen_Feb2022/Jing_projects/biospecQC_03082022/data/",tb,"_no_pii_Short_similar_query_coalesce_",Sys.Date(),".txt",sep=""), sep="\t",row.names = F,quote = F,col.names = F) 
 }
  longtails.only <- schema$column_name[which(!duplicated(schema$var.pattern) & schema$long.Ending == 1 & schema$pii_cid3 !=1)]
  sql.longrename <- filter(schema, column_name %in% longtails.only) %>% select(column_name,newname.long) %>%
    mutate(sql.txt= glue('{column_name} AS {newname.long}'))
  
  write.table(glue("SELECT Connect_ID,\n ",paste(sql.longrename$sql.txt,collapse=",\n"), " \nFROM  `nih-nci-dceg-connect-prod-6d04.FlatConnect.",tb,"`"), paste0("~/Documents/Connect_projects/Biospecimen_Feb2022/Jing_projects/biospecQC_03082022/data/",tb,"_no_pii_LongTails_only_query_Renaming_",Sys.Date(),".txt",sep=""), sep="\t",row.names = F,quote = F,col.names = F) 
  

  return(schema)
}
  dups <- schema$var.pattern[duplicated(schema$var.pattern)]
  schema_dup <- schema %>% filter(.,grepl(paste(dups,collapse="|"),column_name) | long.Ending==1)
  
  dups <- schema_m1v2$var.pattern[duplicated(schema_m1v2$var.pattern) & schema_m1v2$pii_cid3==1]
# [1] "D_537137982_1_1_D_338020179_1" "D_537137982_2_2_D_338020179_2" "D_537137982_3_3_D_338020179_3" "D_537137982_4_4_D_338020179_4"
# [5] "D_537137982_5_5_D_338020179_5" "D_537137982_6_6_D_338020179_6" "D_537137982_7_7_D_338020179_7" "D_537137982_8_8_D_338020179_8"
# [9] "D_537137982_9_9_D_338020179_9"
dd[grepl("338020179",dd$CID),]
# A tibble: 1 × 3
  # CID       `Variable Label`               `Variable Name`            
  # <chr>     <chr>                          <chr>                      
# 1 338020179 Sibling 1 age at death, number SrvBOH_Sib1AgeDeathNum_v1r0  

```

